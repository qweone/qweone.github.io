<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Chandler Kwok"><meta name="copyright" content="Chandler Kwok"><title>熟能生巧 | 郭大瞎のBlog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://i.loli.net/2020/05/05/r8BpGnwzsW25QSN.jpg"></div><div class="author-info__name text-center">Chandler Kwok</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">52</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">52</span></a></div></div></div><nav id="nav" style="background-image: url(https://tva1.sinaimg.cn/large/007S8ZIlgy1get1mqmvxij31hc0u0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">郭大瞎のBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">郭大瞎のBlog</div><div id="site-sub-title">熟能生巧</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/05/19/dns-resolve/">dns resolve</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-19</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/dns%E8%A7%A3%E6%9E%90/">dns解析</a></span><div class="content"><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gexlprvvx5j31k409wdkq.jpg" alt="image-20200519113212054"></p>
<p>如上图Route53，dns的解析 dev1-dop.nearbydirect.com 返回来的是dop-gateway-web-dev1.dop-dev1.svc.cs-software.local。然后客户端再发起dop-gateway-web-dev1.dop-dev1.svc.cs-software.local的解析请求。<em>误区：并不是由ns服务器完成全部解析将最终ip返回给客户端</em></p>
<p>今天这个错误，犯的让我自己自己生自己气了。😠😠😠</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/05/17/ipcalc/">MAC 上的快速IP计算工具：ipcalc</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-17</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ipcalc/">ipcalc</a></span><div class="content"><p>🤩🤩🤩 运维，怎么可能脱离网络呢。</p>
<p>mac上，发现一个工具，IP地址快速计算神器。</p>
<p>工具虽好，但是原理必须清清楚楚呢！</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1geves7f8bwj30rk0aek2g.jpg" alt="image-20200517140113630"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/05/14/gitlab-kubernetes-runner/">gitlab kubernetes runner</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-14</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/kubernetes/">kubernetes</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/gitlab-runner/">gitlab-runner</a></span><div class="content"><p>提交代码后，由kubernetes中的gitlab-runner，编译构建发布。光是想想就好鸡冻了，对不对。如果gitlab-runner 也直接在kubernetes 中，随着任务量的变动而自动伸缩，多美妙啊。</p>
<ol>
<li><p>部署gitlab runner</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> gitlab-runner chart的value文件，最重要是修改gitlabUrl， 与注册token。</span></span><br><span class="line"></span><br><span class="line">[root@ip-10-20-1-93 gitlab-runner]# grep -v '#' values.yaml  | grep -v '^$'</span><br><span class="line">imagePullPolicy: IfNotPresent</span><br><span class="line">gitlabUrl: http://gitlab.srv.sunvalley/</span><br><span class="line">runnerRegistrationToken: "3Pvqyxm3AJUURXkHW44K"</span><br><span class="line">unregisterRunners: true</span><br><span class="line">terminationGracePeriodSeconds: 3600</span><br><span class="line">concurrent: 10</span><br><span class="line">checkInterval: 30</span><br><span class="line">rbac:</span><br><span class="line">  create: true</span><br><span class="line">  clusterWideAccess: false</span><br><span class="line">metrics:</span><br><span class="line">  enabled: true</span><br><span class="line">runners:</span><br><span class="line">  image: ubuntu:16.04</span><br><span class="line">  privileged: true</span><br><span class="line">  pollTimeout: 180</span><br><span class="line">  outputLimit: 4096</span><br><span class="line">  cache: &#123;&#125;</span><br><span class="line">  builds: &#123;&#125;</span><br><span class="line">  services: &#123;&#125;</span><br><span class="line">  helpers: &#123;&#125;</span><br><span class="line">securityContext:</span><br><span class="line">  fsGroup: 65533</span><br><span class="line">  runAsUser: 100</span><br><span class="line">resources: &#123;&#125;</span><br><span class="line">affinity: &#123;&#125;</span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line">tolerations: []</span><br><span class="line">hostAliases: []</span><br><span class="line">podAnnotations: &#123;&#125;</span><br><span class="line">podLabels: &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>下一步在代码仓库中，配置k8s集群的信息。企业版可以对不同的环境配置做权限管控以及owner才有的发布控制，强烈推gitlab企业版。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkadrscw1uj31o40u0naf.jpg" alt="image-20201102053124592"></p>
</li>
<li><p>接下来就是让gitlab runner 跑起来印证咯。</p>
<p>代码仓库中，创建.gitlab-ci.yml。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#variables:</span></span><br><span class="line"><span class="comment">#  MAVEN_CLI_OPTS: "-s .m2/settings.xml --batch-mode"</span></span><br><span class="line"><span class="comment">#  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"</span></span><br><span class="line"><span class="comment">#  DOCKER_HOST: "http://10.20.0.108:2375"</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#build:</span></span><br><span class="line"><span class="comment">#  stage: build</span></span><br><span class="line"><span class="comment">#  image: harbor.sunvalley.com.cn/library/maven:3.0.5</span></span><br><span class="line"><span class="comment">#  script: </span></span><br><span class="line"><span class="comment">#    - test CI_COMMIT_REF_NAME == "master" &amp;&amp; IMAGE_VERSION="latest" || IMAGE_VERSION=$CI_COMMIT_REF_NAME</span></span><br><span class="line"><span class="comment">#    - mvn $MAVEN_CLI_OPTS clean package docker:build -DpushImage -Dmaven.test.skip=true -Dimage.version=$&#123;IMAGE_VERSION&#125;</span></span><br><span class="line"><span class="comment">#  cache:</span></span><br><span class="line"><span class="comment">#    paths:</span></span><br><span class="line"><span class="comment">#      - .m2/repository/</span></span><br><span class="line"><span class="comment">#  artifacts: </span></span><br><span class="line"><span class="comment">#    paths:</span></span><br><span class="line"><span class="comment">#      - target/*.jar</span></span><br><span class="line"><span class="comment">#    expire_in: 2 week </span></span><br><span class="line"><span class="comment">#  environment:</span></span><br><span class="line"><span class="comment">#    name: test</span></span><br><span class="line"><span class="comment">#  only:</span></span><br><span class="line"><span class="comment">#    - tags</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">echo</span> <span class="string">"skipping test"</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tags</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">harbor.sunvalley.com.cn/library/kubectl-tools:1.16.3</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://kube-dashboard.sunvalley.com.cn</span> <span class="comment">#内网开发注册中心</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tags</span> <span class="comment"># tag分支 commit 之后触发</span></span><br><span class="line">  <span class="attr">script:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">"deploy to test"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">version</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cd</span> <span class="string">manifests/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">"s/__CI_PROJECT_NAME__/$&#123;CI_PROJECT_NAME&#125;/"</span> <span class="string">*.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">"s/__CI_ENVIRONMENT_SLUG__/$&#123;CI_ENVIRONMENT_SLUG&#125;/"</span> <span class="string">*.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">"s/__VERSION__/$&#123;CI_COMMIT_REF_NAME&#125;/"</span> <span class="string">*.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">      <span class="string">if</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">deployment.yaml</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-q</span> <span class="string">unchanged;</span> <span class="string">then</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">"=&gt; Patching deployment to force image update."</span></span><br><span class="line">          <span class="string">kubectl</span> <span class="string">patch</span> <span class="string">-f</span> <span class="string">deployment.yaml</span> <span class="string">-p</span> <span class="string">"&#123;\"spec\":&#123;\"template\":&#123;\"metadata\":&#123;\"annotations\":&#123;\"ci-last-updated\":\"$(date +'%s')\"&#125;&#125;&#125;&#125;&#125;"</span></span><br><span class="line">      <span class="string">else</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">"=&gt; Deployment apply has changed the object, no need to force image update."</span></span><br><span class="line">      <span class="string">fi</span></span><br><span class="line"><span class="comment">#    - kubectl rollout status -f deployment.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">all,ing</span> <span class="string">-l</span> <span class="string">env=$&#123;CI_ENVIRONMENT_SLUG&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/05/13/redis-cli-cluster-mode/">redis-cli -c 的误解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-13</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/redis-cluster/">redis cluster</a></span><div class="content"><p>内部系统使用的一个AWS Elasticcache集群，不知不觉就扩容到8个node节点。被迫从AWS Elasticcache Redis上导出snapshot文件到S3，准备用作做分析。</p>
<p>分析工具是一个python实现的rbdtools </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install rbdtools</span><br><span class="line">rdb -c memory /tmp/dump.rdb</span><br></pre></td></tr></table></figure>

<p>实际上导出的中共有8个rbd文件，分析结果会生成csv文件。分析后，发现是大量登陆token，没有设置ttl。开发后续核对代码，才知道登陆时设置ttl了，但在更新权限时，忘记带上ttl值。于是日积月累产生越来越多无用的数据。</p>
<p>接下来就是清理了。</p>
<ul>
<li>方案一：</li>
</ul>
<p>取出没ttl的key的空闲时间，进行倒序排列，删除半年都没人访问的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -h 10.20.0.111 -p 6379 --scan --pattern erpToken* | xargs -r -t -n1  redis-cli -c -h 10.20.0.112 -p 6379 object idletime </span><br><span class="line">// 取出后，通过程序删除</span><br></pre></td></tr></table></figure>



<ul>
<li>方案二：</li>
</ul>
<p>通过rename命令，变更key的name。后续再清理</p>
<ul>
<li>方案三：</li>
</ul>
<p>直接清空全部 key name 为erpToken* 模式的数据。</p>
<p>然而，此处有一个坑，redis-cli -c 的cluster 模式，并不会帮你跳转到所有节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -h 10.20.0.118 -p 6379 --scan --pattern erpToken* </span><br><span class="line">redis-cli -c -h 10.20.0.118 -p 6379 keys erpToken* </span><br><span class="line">// 这两条命令，都只是在client连接到的节点上列出数据</span><br><span class="line"></span><br><span class="line">redis-cli -c -h 10.20.0.111 -p 6379 --scan --pattern erpToken* | xargs -r -t -n1  redis-cli -c -h 10.20.0.112 -p 6379 del</span><br><span class="line">// 其实也只是清空了其中一个节点而已。正确的做法，只能通过for循环，取出master节点，逐个连接上去清理。</span><br></pre></td></tr></table></figure>



<p>其实 redis-cli 的 -c 参数，help如下：Enable cluster mode (follow -ASK and -MOVED redirections)。所以只是针对取特定值的时候，帮助做跳转而已。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/05/05/python-virtual-enviroment/">python virtual enviroment</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-05</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/python/">python</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/jupyter/">jupyter</a></span><div class="content"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建虚拟环境</span></span><br><span class="line">python -m venv .venv</span><br><span class="line"><span class="comment"># 切换到虚拟环境</span></span><br><span class="line"><span class="built_in">source</span> .venv/bin/active</span><br><span class="line"><span class="comment"># 添加环境中的python Kernel到juypter,当然下面的projectname 还是改一个合适的名称哦</span></span><br><span class="line">ipython kernel install --user --name=projectname</span><br><span class="line"><span class="comment"># 切到项目工作空间</span></span><br><span class="line"><span class="built_in">cd</span> workspace</span><br><span class="line"><span class="comment"># 运行jupyter</span></span><br><span class="line">jupyter notebook</span><br></pre></td></tr></table></figure>

<p>最终就能在下图位置中，找到虚拟的环境了。如果要需要安装第三方包，jupyter也可以直接开启termial安装。用来做调试小爬虫很轻巧呢。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1geik0bstg3j30wx09wwg2.jpg" alt="image-20200506110943033"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/05/05/BeautifulSoup/">BeautifulSoup</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-05</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/python/">python</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/beautifulSoup4/">beautifulSoup4</a></span><div class="content"><p>HTML说到底还是XML标记语言，因此解析XML在爬虫抓取结果后，对数据进行拆解分析，变少不了BeautifulSoup4了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">~/code/algorithm via algorithm </span><br><span class="line">➜ cat bf4.py            </span><br><span class="line"><span class="comment">#!/bin/env python3</span></span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line"></span><br><span class="line">html_doc = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse's story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;p class="</span>title<span class="string">"&gt;&lt;b&gt;The Dormouse's story&lt;/b&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p class="</span>story<span class="string">"&gt;Once upon a time there were three little sisters; and their names were</span></span><br><span class="line"><span class="string">&lt;a href="</span>http://example.com/elsie<span class="string">" class="</span>sister<span class="string">" id="</span>link1<span class="string">"&gt;Elsie&lt;/a&gt;,</span></span><br><span class="line"><span class="string">&lt;a href="</span>http://example.com/lacie<span class="string">" class="</span>sister<span class="string">" id="</span>link2<span class="string">"&gt;Lacie&lt;/a&gt; and</span></span><br><span class="line"><span class="string">&lt;a href="</span>http://example.com/tillie<span class="string">" class="</span>sister<span class="string">" id="</span>link3<span class="string">"&gt;Tillie&lt;/a&gt;;</span></span><br><span class="line"><span class="string">and they lived at the bottom of a well.&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p class="</span>story<span class="string">"&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line">soup = BeautifulSoup(html_doc, <span class="string">'lxml'</span>)</span><br><span class="line"><span class="built_in">print</span>(soup.prettify())%                                                                                 </span><br><span class="line"></span><br><span class="line">~/code/algorithm via algorithm </span><br><span class="line">➜ python bf4.py</span><br><span class="line"></span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse<span class="string">'s story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;p class="title"&gt;&lt;b&gt;The Dormouse'</span>s story&lt;/b&gt;&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p class=<span class="string">"story"</span>&gt;Once upon a time there were three little sisters; and their names were</span><br><span class="line">&lt;a href=<span class="string">"http://example.com/elsie"</span> class=<span class="string">"sister"</span> id=<span class="string">"link1"</span>&gt;Elsie&lt;/a&gt;,</span><br><span class="line">&lt;a href=<span class="string">"http://example.com/lacie"</span> class=<span class="string">"sister"</span> id=<span class="string">"link2"</span>&gt;Lacie&lt;/a&gt; and</span><br><span class="line">&lt;a href=<span class="string">"http://example.com/tillie"</span> class=<span class="string">"sister"</span> id=<span class="string">"link3"</span>&gt;Tillie&lt;/a&gt;;</span><br><span class="line">and they lived at the bottom of a well.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p class=<span class="string">"story"</span>&gt;...&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"bf4.py"</span>, line 19, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    soup = BeautifulSoup(html_doc, <span class="string">'lxml'</span>)</span><br><span class="line">  File <span class="string">"/Users/chandler.kwok/code/algorithm/.venv/lib/python3.7/site-packages/bs4/__init__.py"</span>, line 228, <span class="keyword">in</span> __init__</span><br><span class="line">    % <span class="string">","</span>.join(features))</span><br><span class="line">bs4.FeatureNotFound: Couldn<span class="string">'t find a tree builder with the features you requested: lxml. Do you need to install a parser library?</span></span><br></pre></td></tr></table></figure>

<p>简单的按照例子，结果第一步便是报错。原因是 pip3 install beautifulsoup4 还不足以。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/27/promethues-consul/">Promethues Consul监控</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-27</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/consul/">consul</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/prometheus/">prometheus</a></span><div class="content"><p>一边在做数据库备份，一边写😭。</p>
<p>下午抽空，在K8S的Promethues上接入了consul。完成了微服务的JVM监控。</p>
<p><img src="https://i.loli.net/2020/04/27/3cHMkF9Yyd4GNaI.png" alt="image.png"></p>
<p>记录一下步骤：</p>
<ol>
<li><p>创建generic secret ，内容为Prometheus 的 consul自动发现配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-20-1-93 consul-prometheus]# cat prometheus-additional.yaml</span><br><span class="line">- job_name: 'consul-dop-dev1'</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  consul_sd_configs:</span><br><span class="line">      - server: dop-otter-consul-dev1.dop-dev1.svc.cs-software.local:8500</span><br><span class="line">[root@ip-10-20-1-93 consul-prometheus]# kubectl create secret generic additional-scrape-configs --from-file=prometheus-additional.yaml --dry-run -oyaml &gt; additional-scrape-configs.yaml</span><br><span class="line">[root@ip-10-20-1-93 consul-prometheus]# kubectl apply -f additional-scrape-configs.yaml -n prometheus</span><br><span class="line">secret/additional-scrape-configs configured</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改CRD Prometheus </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在spec中增加additionalScrapeConfigs的定义</span></span><br><span class="line">spec:</span><br><span class="line">  additionalScrapeConfigs:</span><br><span class="line">    key: prometheus-additional.yaml</span><br><span class="line">    name: additional-scrape-configs</span><br></pre></td></tr></table></figure>
</li>
<li><p>Reload 一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-20-1-93 consul-prometheus]# curl -X POST http://10.20.210.204:9090/-/reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>Grafana 导入 <a href="https://grafana.com/grafana/dashboards/10280" target="_blank" rel="noopener"><em>Spring Boot 2.1 Statistics</em></a></p>
<p>很快看到结果。</p>
</li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/17/docker-namespace/">docker-namespace</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-17</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/docker-%E4%B9%8B%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4/">docker 之命名空间</a></span><div class="content"></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/16/mysql%E9%94%81/">mysql锁</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-16</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mysql-%E9%94%81%E6%9C%BA%E5%88%B6/">mysql 锁机制</a></span><div class="content"><p>内容仅为个人理解，我也在不断的纠正自己的理解。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 以下讨论都基于：Innodb，事务隔离机制采用RR</span></span><br><span class="line"><span class="keyword">select</span> @@global.tx_isolation;</span><br><span class="line">REPEATABLE-READ</span><br></pre></td></tr></table></figure>

<p>First Of All，Mysql数据库在事务隔离级别为RR的情况下，如果要避免幻读，就要通过间隙锁。那么如何最简单的实现间隙锁，就是通过select语句中 for update 排他锁。正常的select语句是不会加锁的。而是通过访问记录的版本链的过程，实现MVCC（多版本并发控制），也可以简单的理解为快照读，并不加锁。在select for update， 还有 insert， update， delete 的时候，就需要考虑锁机制了。另外mysql的锁，锁定的是索引，并不是数据。</p>
<h3 id="行锁算法（注意是算法哦）"><a href="#行锁算法（注意是算法哦）" class="headerlink" title="行锁算法（注意是算法哦）"></a>行锁算法（注意是算法哦）</h3><ul>
<li><p>普通行锁</p>
<p>唯一索引，且查询的记录存在</p>
</li>
<li><p>间隙锁</p>
<p>锁定一个范围，但不包括记录本身。GAP锁的目的，是为了防止同一事务的两次当前读，出现幻读的情况。</p>
<p>常见于，<strong>键值不存在条件范围内</strong>，叫做间隙（GAP），引擎会对该“间隙”加锁。</p>
</li>
<li><p>Next-key Lock（行锁&amp;间隙锁）</p>
<p>相当于两种锁的结合。锁定一个范围，并且锁定记录本身。对于行的查询，都是采用该方法，主要目的是解决幻读的问题。</p>
</li>
</ul>
<h2 id="锁的类型："><a href="#锁的类型：" class="headerlink" title="锁的类型："></a>锁的类型：</h2><p>共享锁（S）、排他锁（X）、意向共享（IS）、意向排他（IX）</p>
<p>行锁，表锁其实是锁的粒度的概念，共享锁和排它锁是具体的实现。</p>
<p>共享锁（S）： 允许其他事务来读取，但是阻止其他事务，在该行获取该行的排它锁。简单的记忆：能读不能写。共享锁的查询举例： select … lock in share mode。</p>
<p>排它锁（X）： 允许持有排它锁的事务读写数据，阻止其他事务获取该行的共享锁和排它锁。但是其他事务还是可以读的。（普通的select语句，并不影响数据查询）。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 排它锁的举例：</span></span><br><span class="line"><span class="keyword">update</span> ...</span><br><span class="line"><span class="keyword">delete</span> ...</span><br><span class="line"><span class="keyword">insert</span> ...</span><br><span class="line"><span class="keyword">select</span> ... <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>



<h3 id="间隙锁之举例"><a href="#间隙锁之举例" class="headerlink" title="间隙锁之举例"></a>间隙锁之举例</h3><p>前言：始终不要忘记间隙锁的目的，是为了解决幻读。所以开发工作中，要主动思考，规避在某些并发环境下，会出现幻读，常见做法便是：在sql中加入for update，或是乐观锁。在运维工作中，也要留意数据库，出现同样间隙锁的性能问题。（遇到过，数据库大量的insert 导致的间隙锁）</p>
<ol>
<li></li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/04/16/docker-cache/">Docker Cache</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-16</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/docker-cache/">docker cache</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/docker-build-%E5%8A%A0%E9%80%9F/">docker build 加速</a></span><div class="content"><p>Docker 镜像在build的过程中，默认会有一套缓存机制。</p>
<p>用自己的语言直白描述 ，能更容易记住呢。</p>
<ol>
<li><p>Docker 镜像默认是一层一层的叠加上去。dockerfile中的每一行，对应就是一层。</p>
</li>
<li><p>每次构建，Docker会比对每一层是否有变化，如果构建命令没有–no-cache=true 参数，默认都会尽量用上缓存。</p>
</li>
<li><p>Docker如何判断这一层是否变化呢。ADD，COPY的层，docker会去比对文件，计算文件的校验和。（校验和中不考虑最后修改和最后访问时间）。其余的层，会去比对字符串。一旦其中一层发生了变化，在此之上的所有层，都不会再用到缓存了。</p>
</li>
</ol>
<p>学了原理，当然要知道怎么优雅的使用呢：</p>
<ul>
<li>据一个🌰</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">from</span> <span class="string">centos-alpha</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">yum</span> <span class="string">update</span> <span class="string">-y</span> <span class="string">&amp;&amp;</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">epel</span> <span class="string">-y</span> <span class="string">&amp;&amp;</span> <span class="string">yum</span> <span class="string">xxxx</span></span><br><span class="line"><span class="string">CMD</span> <span class="string">COMMAND</span></span><br></pre></td></tr></table></figure>

<p>如上，我们在调试dockerfile的时候，常常会多次构建，过程中，可能发现缺少依赖包，变反复修改第二层的RUN指令。</p>
<p>而yum update -y ，却是每次最耗时的指令。如果独立层单独一层，就发现速度飞快了。</p>
<ul>
<li>再举一个🌰</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">node-alpha</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">/src</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">cd</span> <span class="string">/src</span> <span class="string">&amp;&amp;</span> <span class="string">npm</span> <span class="string">install</span></span><br></pre></td></tr></table></figure>

<p>如上，第三层中，每一次npm install 会安装package.json中指定的依赖。而如果一个项目在定型后，package.json在变更的频率会非常少，于是聪明的做法是将其改为</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">node-alpha</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">package.json</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">install</span> </span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">/src</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">xxxx</span></span><br></pre></td></tr></table></figure>

<p>这样，在第二层package.json文件不变的情况下，在jenkins 构建编译的时候，可以重复利用第二层。速度也随之加快多了。</p>
<p>好的，那么新的问题来了，docker 镜像在开发测试与生产环境物理距离遥远的企业中，应该如何放置呢。像现在的公司，开发测试等环节都在内部的办公机房里。而生产环境远在aws 俄勒冈。镜像的同步受网络条件制约。对此我们内部出现了多种设想。</p>
<ol>
<li><p>异地编译，生成镜像。同事说在aws环境内，单独完成生产环境的构建编译镜像封装。</p>
</li>
<li><p>镜像同步，开发测试环境，在稳定后将镜像同步到特定的仓库。改仓库再通过mirror同步到海外的registey。</p>
<p>我选择了2。原因是容器的目的之一，便是将运行环境也纳入到版本控制中，方案一存在巨大的漏洞，两次构建编译，其中存在不确定因素，所以被彻底否决。</p>
</li>
</ol>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://tva1.sinaimg.cn/large/007S8ZIlgy1get1mqmvxij31hc0u0q7i.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 By Chandler Kwok</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>