<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Chandler Kwok"><meta name="copyright" content="Chandler Kwok"><title>熟能生巧 | 郭大瞎のBlog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://i.loli.net/2020/05/05/r8BpGnwzsW25QSN.jpg"></div><div class="author-info__name text-center">Chandler Kwok</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">44</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">48</span></a></div></div></div><nav id="nav" style="background-image: url(https://tva1.sinaimg.cn/large/007S8ZIlgy1get1mqmvxij31hc0u0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">郭大瞎のBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">郭大瞎のBlog</div><div id="site-sub-title">熟能生巧</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/28/Todo-list/">Todo list</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-28</time><div class="content"><p>将会更新的文章或着感兴趣的议题</p>
<ul>
<li><p>aws vpc 子网隔离</p>
</li>
<li><p>容器中的文件</p>
</li>
<li><p>k8s crd &amp; operator</p>
</li>
<li><p>alertmanager 配置文件与告警使用</p>
</li>
<li><p>python sqlalchemy</p>
</li>
<li><p>scrum 敏捷开发</p>
</li>
<li><p>ECMAScript6 持续更新</p>
</li>
<li><p>浮点型（python/javascript/golang）</p>
</li>
<li><p>python 魔术方法</p>
</li>
<li><p>helm hooks</p>
</li>
<li><p>python import 注意事项</p>
</li>
<li><p>rook-ceph-k8s</p>
</li>
<li><p>vue相关</p>
</li>
<li><p>linux kernal namespace</p>
</li>
<li><p>Mvcc</p>
</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/10/31/K8S-Jenkins-CICD/">K8S &amp; Jenkins CICD</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-10-31</time><div class="content"><p>公司内部各个开发团队，一直有独立运作的习惯，持续集成基本是各自的Jenkins，又由于办公内网，没有足够的硬件资源，搭建ceph这类的分布式存储（我也尝试用几台虚机，搭建了ceph，并测试了存储io，性能感人的差，经费也下不来），所以Jenkins 也一直放在K8S集群外。接下里简单记录一下目前的使用方式</p>
<ol>
<li><p>Jenkins添加集群信息：</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gka14jnmdpj311t0u07jq.jpg" alt="image-20201101221351225"></p>
</li>
<li><p>添加用于构建镜像的docker主机，实际上镜像打包还可以通过maven的插件，开发同事在本地开发构建时便是通过maven的docker插件。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gka15f6yunj31s60nqte1.jpg" alt="image-20201101221444117"></p>
</li>
<li><p>编写Jenkins的Dockerfile（略，springcloud微服务的话，官方有一个案例，拿来开始改改就可以用了）</p>
</li>
<li><p>仓库里添加jenkinsfile，在此需要考虑到各种语言的编译过程的包的缓存，用来加速下一次构建编译的速度，以下便是将maven本地仓库的本地路径，挂载到PVC中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123;</span><br><span class="line">    kubernetes &#123;</span><br><span class="line">      cloud &#39;k8s-api-cs-software.sunvalley.com.cn&#39;</span><br><span class="line">      nodeSelector &#39;app&#x3D;jenkins&#39;</span><br><span class="line">      idleMinutes 5</span><br><span class="line">      yaml &quot;&quot;&quot;</span><br><span class="line">        apiVersion: v1</span><br><span class="line">        kind: Pod</span><br><span class="line">        metadata:</span><br><span class="line">          labels:</span><br><span class="line">            app: jenkins-jnlp</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - name: jnlp</span><br><span class="line">            image: harbor.sunvalley.com.cn&#x2F;library&#x2F;jenkins-jnlp-slave:3.35-5</span><br><span class="line">          - name: maven</span><br><span class="line">            image: cs-harbor.sunvalley.com.cn&#x2F;library&#x2F;maven-base-image:3.0.5</span><br><span class="line">            command:</span><br><span class="line">            - cat</span><br><span class="line">            tty: true</span><br><span class="line">            volumeMounts:</span><br><span class="line">            - mountPath: &#x2F;data&#x2F;m2_dev&#x2F;</span><br><span class="line">              name: m2-dev</span><br><span class="line">          - name: docker-ci</span><br><span class="line">            image: harbor.sunvalley.com.cn&#x2F;library&#x2F;docker-ci:v19.03.5</span><br><span class="line">            command:</span><br><span class="line">            - cat</span><br><span class="line">            tty: true</span><br><span class="line">            volumeMounts:</span><br><span class="line">            - mountPath: &#x2F;var&#x2F;run&#x2F;docker.sock</span><br><span class="line">              name: docker-sock</span><br><span class="line">            - mountPath: &#x2F;data&#x2F;m2_dev&#x2F;</span><br><span class="line">              name: m2-dev</span><br><span class="line">          - name: kubectl-tools</span><br><span class="line">            image: harbor.sunvalley.com.cn&#x2F;library&#x2F;kubectl-tools:1.16.3</span><br><span class="line">            command:</span><br><span class="line">            - cat</span><br><span class="line">            tty: true</span><br><span class="line">          volumes:</span><br><span class="line">          - name: docker-sock</span><br><span class="line">            hostPath:</span><br><span class="line">              path: &#x2F;var&#x2F;run&#x2F;docker.sock</span><br><span class="line">          - name: m2-dev</span><br><span class="line">            hostPath:</span><br><span class="line">              path: &#x2F;data&#x2F;m2_dev&#x2F;</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        &#x2F;&#x2F;   serviceAccountName: admin-sample-user</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(&#39;Run maven&#39;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        &#x2F;&#x2F; container(&#39;maven&#39;) &#123;</span><br><span class="line">        &#x2F;&#x2F;   sh &#39;mvn -B -f pom.xml -s &#x2F;data&#x2F;m2_dev&#x2F;settings.xml clean package -Dmaven.test.skip&#x3D;true -pl com.sunvalley:mwp-message-center -am -Pdev1 -e -U&#39;</span><br><span class="line">        &#x2F;&#x2F; &#125;</span><br><span class="line">        &#x2F;&#x2F; container(&#39;docker-ci&#39;) &#123;</span><br><span class="line">        &#x2F;&#x2F;   dir(path: &quot;mwp-message-center&quot;) &#123;</span><br><span class="line">        &#x2F;&#x2F;     script &#123;</span><br><span class="line">        &#x2F;&#x2F;       docker.withRegistry(&#39;https:&#x2F;&#x2F;cs-harbor.sunvalley.com.cn&#39;, &#39;harbor&#39; )&#123;</span><br><span class="line">        &#x2F;&#x2F;           def customImage &#x3D; docker.build(&quot;cs-harbor.sunvalley.com.cn&#x2F;internal&#x2F;$&#123;env.JOB_NAME&#125;:$&#123;env.GIT_COMMIT&#125;&quot;)</span><br><span class="line">        &#x2F;&#x2F;           customImage.push()</span><br><span class="line">        &#x2F;&#x2F;       &#125;</span><br><span class="line">        &#x2F;&#x2F;     &#125;</span><br><span class="line">        &#x2F;&#x2F;   &#125;</span><br><span class="line">        &#x2F;&#x2F; &#125;</span><br><span class="line">        container(&#39;kubectl-tools&#39;) &#123;</span><br><span class="line">        &#x2F;&#x2F;   sh &quot;sed -i &#39;s&#x2F;&lt;PROJECT_NAME&gt;&#x2F;$&#123;env.JOB_NAME&#125;&#x2F;&#39; deployment.yaml&quot;</span><br><span class="line">        &#x2F;&#x2F;   sh &quot;sed -i &#39;s&#x2F;&lt;BUILD_TAG&gt;&#x2F;$&#123;env.GIT_COMMIT&#125;&#x2F;&#39; deployment.yaml&quot;</span><br><span class="line">        &#x2F;&#x2F;   sh &#39;kubectl apply -f deployment.yaml&#39;</span><br><span class="line">             sh &quot;kubectl get pods&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="5">
<li><p>Jenkinsfile 无论时声明式还是脚本式。都不是yaml语法，Jenkins自身提供了一个Linter，不过呀。总是在界面上切来切去。有点麻烦。如果是vscode用户可以用下面的插件，毕竟项目多了，jenkinsfile 熟悉了，这个工作会帮上忙。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk88oxttjwj31la0cqk13.jpg" alt="image-20201031090430764"> </p>
</li>
</ol>
<p>然而，也有需要吐糟的地方，Jenkins的插件管理，管理起来好崩溃。有些插件会依赖另一个插件的高版本。所以升级插件的时候，一并把依赖插件一起升级了。举例就是pipeline的升级，把Jenkins maven插件一并升级了。结果新的Jenkins maven的版本不支持jdk1.6。 老旧的java项目构建时报错。又比如jenkins k8s cloud 的插件的部分功能，在较新的Jenkins上才能运行（也是测试了好久才发现），文档半点没提。甚至试过在升级jenkins插件的是，官方下载中心垮掉了。第二天才恢复。</p>
<p>再吐糟一点，Jenkins的agent，需要回调master的端口来通讯，我们目前是固定了50000端口。在跨公网的场景下，就有点为难了，我不想暴露50000端口到公网啊。</p>
<p>还有呀，Jenkins 的K8S 插件，目前不支持在构建编译过程中， 调用两个K8S集群。描述个案例：我在内网自建的K8S构建后，最后一步再apply到AWS的EKS。（还要花点时间，寻找到优雅的解决方式）</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/10/26/AWS-S3-Performance/">AWS S3 Performance</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-10-26</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/S3-performance/">S3 performance</a></span><div class="content"><p>S3 是AWS的最常用的服务之一，但是对于S3的并发连接数，Amazon S3 宣布提高请求速率性能](<a href="https://aws.amazon.com/cn/about-aws/whats-new/2018/07/amazon-s3-announces-increased-request-rate-performance/" target="_blank" rel="noopener">https://aws.amazon.com/cn/about-aws/whats-new/2018/07/amazon-s3-announces-increased-request-rate-performance/</a>)</p>
<p>那在大并发的场景下，如何监控S3的性能呢？下面的文章给出了解答。</p>
<p><a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/optimizing-performance.html" target="_blank" rel="noopener">S3 Best Performance</a></p>
<blockquote>
<p>Your applications can easily achieve thousands of transactions per second in request performance when uploading and retrieving storage from Amazon S3. Amazon S3 automatically scales to high request rates. For example, your application can achieve at least 3,500 PUT/COPY/POST/DELETE or 5,500 GET/HEAD requests per second per <a href="https://docs.aws.amazon.com/general/latest/gr/glos-chap.html#keyprefix" target="_blank" rel="noopener">prefix</a> in a bucket. There are no limits to the number of prefixes in a bucket. You can increase your read or write performance by parallelizing reads. For example, if you create 10 prefixes in an Amazon S3 bucket to parallelize reads, you could scale your read performance to 55,000 read requests per second.</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk5g8e0gl1j31md0u04en.jpg" alt="image-20201028230839926"></p>
<p>S3 控制台和都能找到对应的监控指标。Awesome！</p>
<p>额外的小议题：</p>
<p>我一度设想将S3 bucket 挂在到EKS的pods上，作为日志的输出目录，参照文献：<a href="https://aws.amazon.com/cn/blogs/china/use-u3fs-as-shared-storage-to-kubernetes-pod/" target="_blank" rel="noopener">利用 S3FS 将 S3 作为共享存储挂载到 Kubernetes Pod</a>。但是此处存在一个问题，是一档pods中的容器重启后，日志文件将会被重新覆盖。</p>
<p>采用S3FS的一写注意事项：</p>
<ul>
<li>随机写或追加写需要重写整个文件；</li>
<li>由于网络延迟，所以元数据的操作如列出目录等的性能较差；（备注： 在网络存储方案上，如EFS上，也会有同样的问题）</li>
<li>最终一致性会暂时产生中间数据（AMAZON S3数据一致性模型）；</li>
<li>没有文件和目录的原子重命名；</li>
<li>安装相同存储桶的多个客户端之间没有协调；</li>
<li>没有硬链接；</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/17/vscode-pytest/">vscode pytest</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-17</time><div class="content"><p>有鬼！！！</p>
<p>在vscode，写一个python脚本的时候，原本应该只往数据库里，插入一条数据。可是有时候执行后，却发现插入了多台数据，并且有时候2条，有时候3条。由于脚本的逻辑不算复杂，于是认为是vscode在搞鬼。反复vscode的setting.json文件后，注释部分配置，之后找到了祸根：文件名以test开始，每次保存的时候，触发了pytest自动执行了一次测试。我又习惯多次ctrl + s，所以就莫名其妙的多了不少数据。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/10/EKS-%E6%9C%AD%E8%AE%B0/">EKS 札记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-10</time><div class="content"><p>最近被新规划的中台，忙到焦头烂额。回到EKS话题吧。</p>
<ol>
<li><p>架构和网络的规划。EKS or self-manager K8S，最终投给了EKS，毕竟在我也尝过在AWS 多种部署K8S的方案。</p>
<p>选择EKS最关键的原因是：EKS 的自带CNI，所有的pods都可以无缝和vpc的EC2，无缝调用。</p>
</li>
<li><p>在构建EKS的 VPC，我们采用全public子网的模式，放弃了传统私有子网。原因是这个vpc，</p>
</li>
<li><p>EKS的node虽有公网IP，并没有附加弹性网卡，意味着ASG在伸缩后，node可能被重建了。那么在k8s 定义 service资源时，type选择为node type，并不可靠，毕竟node的IP本身就可能在重启后，变更掉。</p>
</li>
<li><p>其中也有一个小插曲，同事提出来用EKS集群方案，实现网络代理服务应用集群，提供代理IP给爬虫服务。开会中我也脑子热，居然认可了。冷静后，才发现不对劲啊。EKS 的CNI 让每一个pods都能分配到vpc的一个ip地址，但是pods的互联网访问，还是要通过附加在主机的network interface上互联网网关，也就是说通过这个network interface的ip出去呀。简单讲，就是pods 实际还是通过所在ec2的公网IP出去。完全就不是他说的，每个pods 都能搞到一个公网IP，大误啊！</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gglimx1tkaj31st0u0e0v.jpg" alt="image-20200710071931788"></p>
</li>
</ol>
<p>​    5. EKS文档中，自带storageclass的例子，通过sc生产</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/19/multi-EKS-in-VPC/">multi EKS in VPC</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-19</time><div class="content"><blockquote>
<p>Hello Chandler, </p>
<p>Thank you for contacting AWS support. My name is Sypher and I will be helping you and your case today. According to your description, I understand you want to ask that is there have any flaws of creating two EKS cluster in one VPC. If I misunderstand your question, please feel free to correct me. Generally speak, there won’t have any flaws if you deploy two EKS clusters in one VPC. The only thing currently it might need to be noticed is the IP address allocate problem. As you might know, Amazon EKS supports native VPC networking via the Amazon VPC Container Network Interface (CNI) plugin for Kubernetes [1]. Using this CNI plugin allows Kubernetes pods to have the same IP address inside the pod as they do on the VPC network. Thus, it means that each pod will allocate one private IP from your VPC. If each EKS cluster might deploy lots of pods in the future, you might need to consider the IP insufficient problem. After I reviewed your EKS Clusters’ VPC, each subnet still have more that 8000 IPs can use. Hence, I think currently there have no issue you need to worry. However, if you have some questions or encountered the issue in the future, please do not hesitate to reach out us again. We are willing to help you solve the problem.</p>
</blockquote>
<p>综上，为验证我的疑问：一个VPC，创建多个EKS集群，选择相同的子网，是否会有冲突。因此我动手试了一发。如我推测，AWS的EKS 简直棒呆了！由于EKS的CNI插件，使得PODS的网络接口，对应一个VPC中的一个私有ip（network interface）。这个network interface上的安全组规则，实现了网络的互通。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/19/one-cluster-or-many/">one cluster or many</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-19</time><div class="content"><p>在EKS中， 一个集群 OR 多个集群，是一个规划者绕不开的一个问题。我在规划的初期，为每个开发部门（业务独立），创建不同的集群。考虑到集群可能会升级，独立的K8S集群在升级时，关联的业务面也比较可控。</p>
<p>尤其我们额外，帮他们打通了pods cidr与开发办公网段的网络。多个开发团队也都着手将传统部署的应用，容器化，通过K8S作为编排工具。集群的数量以及相应的要求也各有不同。</p>
<p>单一集群，多租户的方式存在多个缺陷：</p>
<ul>
<li>soft multi-tenancy</li>
<li>ops affects all tenants </li>
<li>same K8S Version</li>
</ul>
<p>多集群，多租户的方式：</p>
<ul>
<li>Hypervisor for hard multi-tenancy</li>
<li>blast Radilis limits</li>
<li>diff configs &amp; diff k8s version</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/19/ECMAScript6/">ECMAScript 6</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-19</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ES6-%E5%B7%A9%E5%9B%BA/">ES6 巩固</a></span><div class="content"><p>菜鸟学ES6</p>
<ol>
<li>ES6 之模版</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜ cat aaaa.js   </span><br><span class="line">let name = "koma"</span><br><span class="line"></span><br><span class="line">function dd(format)&#123;</span><br><span class="line">    console.log(format)</span><br><span class="line">&#125;</span><br><span class="line">// dd`4344`</span><br><span class="line">dd(4344)                 </span><br><span class="line"></span><br><span class="line">~/code/algorithm via ⬢ v10.16.0 via algorithm </span><br><span class="line">➜ node aaaa.js </span><br><span class="line">4344</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个就是普通的js方法调用</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜ cat aaaa.js </span><br><span class="line">let name = <span class="string">"koma"</span></span><br><span class="line"></span><br><span class="line">function dd(format,...args)&#123;</span><br><span class="line">    console.log(format)</span><br><span class="line">    console.log(args)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dd`你好吖，$&#123;name&#125;`%                                                                                      </span><br><span class="line"></span><br><span class="line">~/code/algorithm via ⬢ v10<span class="number">.16</span><span class="number">.0</span> via algorithm </span><br><span class="line">➜ node aaaa.js </span><br><span class="line">[ <span class="string">'你好吖，'</span>, <span class="string">''</span> ]</span><br><span class="line">[ <span class="string">'koma'</span> ]</span><br><span class="line"><span class="comment"># 这个就是模版调用</span></span><br><span class="line"><span class="comment"># 好笑的是，我在手机屏幕上，看代码时，一度以为js可以不用带括号，就可以调用方法。😓</span></span><br></pre></td></tr></table></figure>



<ol start="2">
<li><p>ES6 之Symbol</p>
<p>待续。。</p>
</li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/09/EKS-Unauthorized/">EKS Unauthorized</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-09</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/EKS/">EKS</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/IAM/">IAM</a></span><div class="content"><ol>
<li>创建集群，但此次是由同事的IAM账号来创建，创建后的集群，默认只有创建者的可以访问，其他的iam账号（比如我的），<a href="">就需要额外的做一步</a></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[centos@ip-10-100-4-240 ~]$ cat /data/shelley/cluster.yaml</span><br><span class="line">apiVersion: eksctl.io/v1alpha5</span><br><span class="line">kind: ClusterConfig</span><br><span class="line">metadata:</span><br><span class="line">  name: cs-k8s-cluster</span><br><span class="line">  region: us-west-2</span><br><span class="line">  version: '1.16'</span><br><span class="line">  tags:</span><br><span class="line">    'Owner': 'SoftwareDevDept'</span><br><span class="line">vpc:</span><br><span class="line">  id: "vpc-05b756b29c94fef66"  # (optional, must match VPC ID used for each subnet below)</span><br><span class="line">  cidr: "10.100.0.0/16"       # (optional, must match CIDR used by the given VPC)</span><br><span class="line">  subnets:</span><br><span class="line">    # must provide 'private' and/or 'public' subnets by availibility zone as shown</span><br><span class="line">    public:</span><br><span class="line">      us-west-2a:</span><br><span class="line">        id: "subnet-093837539ccacaae8"</span><br><span class="line">        cidr: "10.100.0.0/19" # (optional, must match CIDR used by the given subnet)</span><br><span class="line">      us-west-2b:</span><br><span class="line">        id: "subnet-0b6b35e29c009928a"</span><br><span class="line">        cidr: "10.100.32.0/19"  # (optional, must match CIDR used by the given subnet)</span><br><span class="line">      us-west-2c:</span><br><span class="line">        id: "subnet-01e3bfde4755f67e2"</span><br><span class="line">        cidr: "10.100.64.0/19"   # (optional, must match CIDR used by the given subnet)</span><br><span class="line">      us-west-2d:</span><br><span class="line">        id: "subnet-0286c131713e85585"</span><br><span class="line">        cidr: "10.100.96.0/19"   # (optional, must match CIDR used by the given subnet)</span><br><span class="line">    private:</span><br><span class="line">      us-west-2a:</span><br><span class="line">        id: "subnet-0ca641ee980ff32f9"</span><br><span class="line">        cidr: "10.100.128.0/19" # (optional, must match CIDR used by the given subnet)</span><br><span class="line">      us-west-2b:</span><br><span class="line">        id: "subnet-08c29d1387063d44e"</span><br><span class="line">        cidr: "10.100.160.0/19"  # (optional, must match CIDR used by the given subnet)</span><br><span class="line">      us-west-2c:</span><br><span class="line">        id: "subnet-09c6c0901fb5237a4"</span><br><span class="line">        cidr: "10.100.192.0/19"   # (optional, must match CIDR used by the given subnet)</span><br><span class="line">      us-west-2d:</span><br><span class="line">        id: "subnet-00d5c0082c082cf54"</span><br><span class="line">        cidr: "10.100.224.0/19"   # (optional, must match CIDR used by the given subnet)</span><br><span class="line"></span><br><span class="line">iam:</span><br><span class="line">  serviceRoleARN: "arn:aws:iam::211394563914:role/eksServiceRole"</span><br><span class="line">managedNodeGroups:</span><br><span class="line">  - name: managed-public</span><br><span class="line">    labels: &#123; role: public &#125;</span><br><span class="line">    availabilityZones: ["us-west-2a", "us-west-2b", "us-west-2c", "us-west-2d"]</span><br><span class="line">    instanceType: t2.medium</span><br><span class="line">    minSize: 1</span><br><span class="line">    maxSize: 5</span><br><span class="line">    desiredCapacity: 1</span><br><span class="line">    volumeSize: 100</span><br><span class="line">    tags:</span><br><span class="line">      'Owner': 'SoftwareDevDept'</span><br><span class="line">      'snapshot_days': '7'</span><br><span class="line">    ssh:</span><br><span class="line">      allow: true</span><br><span class="line">      publicKeyName: "Oregon_k8s"</span><br><span class="line">      sourceSecurityGroupIds: ["sg-029e90d289e61032a"]</span><br><span class="line">  - name: managed-private</span><br><span class="line">    labels: &#123; role: private &#125;</span><br><span class="line">    availabilityZones: ["us-west-2a", "us-west-2b", "us-west-2c", "us-west-2d"]</span><br><span class="line">    instanceType: t2.medium</span><br><span class="line">    privateNetworking: true</span><br><span class="line">    minSize: 1</span><br><span class="line">    maxSize: 10</span><br><span class="line">    desiredCapacity: 1</span><br><span class="line">    volumeSize: 100</span><br><span class="line">    tags:</span><br><span class="line">      'Owner': 'SoftwareDevDept'</span><br><span class="line">      'snapshot_days': '7'</span><br><span class="line">    ssh:</span><br><span class="line">      allow: true</span><br><span class="line">      publicKeyName: "Oregon_k8s"</span><br><span class="line">      sourceSecurityGroupIds: ["sg-029e90d289e61032a"]</span><br><span class="line">cloudWatch:</span><br><span class="line">  clusterLogging:</span><br><span class="line">    # enable specific types of cluster control plane logs</span><br><span class="line">    enableTypes: ["audit", "authenticator", "controllerManager", "api", "scheduler"]</span><br><span class="line">    # all supported types: "api", "audit", "authenticator", "controllerManager", "scheduler"</span><br><span class="line">    # supported special values: "*" and "all"</span><br><span class="line">[centos@ip-10-100-4-240 ~]$ eksctl create cluster -f cluster.yaml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>按照官方文档，添加自己的用户到<strong>system:masters</strong>管理员组里。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">edit</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">configmap/aws-auth</span></span><br><span class="line"><span class="string">添加以下用户信息</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">mapUsers:</span> <span class="string">|</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">userarn:</span> <span class="string">arn:aws:iam::111122223333:user/chandler.guo</span></span><br><span class="line"><span class="attr">username:</span> <span class="string">chandler.guo</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">system:masters</span></span><br></pre></td></tr></table></figure>
<p>​    那么此处问题来了，如果我只想给到view的权限呢？由应该如何处理。</p>
<ol start="3">
<li><p>在本地电脑上通过aws client 生成kube config配置。</p>
<p><code>aws eks --region us-west-2 update-kubeconfig --name cs-k8s-cluster</code></p>
</li>
<li><p>回顾：</p>
<p>客户端请求EKS API service 时，kubectl 先调用K8S的API时，aws identify 先验证身份，身份验证通过，才会将请求给到EKS集群，EKS中采用原生的RBAC鉴权，再返回到客户端。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfxcx1pxvqj32b80tywus.jpg" alt="image-20200619094809050"></p>
<p>在此基础上，我又再提出一个疑问</p>
</li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/06/09/distro-for-elasticsearch/">distro for elasticsearch</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-09</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/elasticsearch/">elasticsearch</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/AWS-ES/">AWS ES</a></span><div class="content"><p>AWS ES服务的认证，以往我们依赖与iam access key，但是新版本突然发现了一个新世界：Open Distro for Elasticsearch。<a href="https://opendistro.github.io/for-elasticsearch/" target="_blank" rel="noopener">opendistro官网</a>。并且上开源的，功能描述上，提供认证，还有监控，还有告警。这些功能xpack中也有，当然也是收费的。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gflwgvtzh5j31mp0u07j5.jpg" alt="image-20200609115746773"></p>
<p>角色控制也非常的棒，可配置cluster的权限，索引的权限，租户的权限。分配给普通应用的账号，就不需要cluster里的权限了。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gflwl9lpq4j31850u0qpt.jpg" alt="image-20200609120201552"></p>
<p>功能可不止这一点，还支持用户认证还支持绑定Active Directory and LDAP。可惜有新项目，只能浅尝而止了。</p>
</div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://tva1.sinaimg.cn/large/007S8ZIlgy1get1mqmvxij31hc0u0q7i.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By Chandler Kwok</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>